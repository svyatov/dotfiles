source "$HOME/.config/svyatov/aliases"

### Functions
function autosudo() {
    if [[ $EUID -ne 0 ]]; then
        sudo "$@"
    else
        "$@"
    fi
}

### Package manager detection
_detect_pkg_manager() {
    if command -v apt-get &>/dev/null; then
        echo "apt"
    elif command -v dnf &>/dev/null; then
        echo "dnf"
    elif command -v yum &>/dev/null; then
        echo "yum"
    else
        echo "unknown"
    fi
}
_PKG_MANAGER=$(_detect_pkg_manager)

### Completions
# Find completion file in common locations
_find_completion() {
    local name="$1"
    for dir in /usr/share/bash-completion/completions /etc/bash_completion.d; do
        [[ -f "$dir/$name" ]] && echo "$dir/$name" && return
    done
}

# Source completions if not already loaded
_apt_get_completion=$(_find_completion apt-get)
if [[ -z "$(type -t _apt_get)" ]] && [[ -n "$_apt_get_completion" ]]; then
    source "$_apt_get_completion"
fi

_apt_cache_completion=$(_find_completion apt-cache)
if [[ -z "$(type -t _apt_cache)" ]] && [[ -n "$_apt_cache_completion" ]]; then
    source "$_apt_cache_completion"
fi

_service_completion=$(_find_completion service)
if [[ -z "$(type -t _service)" ]] && [[ -n "$_service_completion" ]]; then
    source "$_service_completion"
fi

### Aliases
safe_alias vsaa 'v "$SVYATOV_DIR/admin_aliases"'
safe_alias ssaa 'source "$SVYATOV_DIR/admin_aliases"'
safe_alias s 'autosudo'
safe_alias r 's su -'
safe_alias n 's netstat -tulpen'
safe_alias ne "n | awk '\$4 !~ /(127\.0\.0\.1:|::1:)/ {print \$0}'" # show external IPs only
safe_alias i 's iptables -L -v -n'
safe_alias t 'tmux attach || tmux new'

### Package manager aliases (conditional by distro)
case "$_PKG_MANAGER" in
    apt)
        safe_alias agi 's apt-get install -y'
        if type -t _apt_get &>/dev/null; then
            make-completion-wrapper _apt_get _agi apt-get install
            complete -F _agi agi
        fi
        safe_alias agu 's apt-get update'
        safe_alias agg 's apt-get upgrade -uV'
        safe_alias agdu 's apt-get dist-upgrade'
        safe_alias aguu 'agu && agg'
        safe_alias addrepo 's add-apt-repository'
        safe_alias acf 's apt-cache search'
        if type -t _apt_cache &>/dev/null; then
            make-completion-wrapper _apt_cache _acf apt-cache search
            complete -F _acf acf
        fi
        safe_alias acs 's apt-cache show'
        if type -t _apt_cache &>/dev/null; then
            make-completion-wrapper _apt_cache _acs apt-cache show
            complete -F _acs acs
        fi
        safe_alias agr 's apt-get remove'
        if type -t _apt_get &>/dev/null; then
            make-completion-wrapper _apt_get _agr apt-get remove
            complete -F _agr agr
        fi
        safe_alias agp 's apt-get purge'
        if type -t _apt_get &>/dev/null; then
            make-completion-wrapper _apt_get _agp apt-get purge
            complete -F _agp agp
        fi
        safe_alias agcl 's apt-get changelog'
        if type -t _apt_get &>/dev/null; then
            make-completion-wrapper _apt_get _agcl apt-get changelog
            complete -F _agcl agcl
        fi
        safe_alias agc 's apt-get clean'
        safe_alias agar 's apt-get autoremove'
        ;;
    dnf|yum)
        safe_alias agi "s $_PKG_MANAGER install -y"
        safe_alias agu "s $_PKG_MANAGER check-update"
        safe_alias agg "s $_PKG_MANAGER upgrade -y"
        safe_alias agr "s $_PKG_MANAGER remove"
        safe_alias acf "s $_PKG_MANAGER search"
        safe_alias acs "s $_PKG_MANAGER info"
        safe_alias agc "s $_PKG_MANAGER clean all"
        safe_alias agar "s $_PKG_MANAGER autoremove"
        ;;
esac

### Service management (systemd or legacy service)
if command -v systemctl &>/dev/null; then
    safe_alias ssr 's systemctl'
    # Try to load systemctl completions
    _systemctl_completion=$(_find_completion systemctl)
    if [[ -z "$(type -t _systemctl)" ]] && [[ -n "$_systemctl_completion" ]]; then
        source "$_systemctl_completion"
    fi
    if type -t _systemctl &>/dev/null; then
        complete -F _systemctl ssr
    fi
else
    safe_alias ssr 's service'
    if type -t _service &>/dev/null; then
        make-completion-wrapper _service _ssr_service service
        complete -F _ssr_service ssr
    fi
fi

### Config directory shortcuts
safe_alias lgrt 'cd /etc/logrotate.d'
safe_alias logs 'cd /var/log'

### Kernel management (APT-based systems only)
if [[ "$_PKG_MANAGER" == "apt" ]]; then
    remove-old-kernels() {
        echo "This will remove old kernel packages."
        echo "Current kernel: $(uname -r)"
        echo ""
        local old_kernels=$(dpkg -l linux-{image,headers}-"[0-9]*" 2>/dev/null | awk '/ii/{print $2}' | grep -ve "$(uname -r | sed -r 's/-[a-z]+//')")
        if [[ -z "$old_kernels" ]]; then
            echo "No old kernels found to remove."
            return 0
        fi
        echo "Packages to remove:"
        echo "$old_kernels"
        echo ""
        read -p "Continue? [y/N] " confirm
        [[ "$confirm" =~ ^[Yy]$ ]] || { echo "Aborted"; return 1; }
        autosudo apt-get purge $old_kernels
    }
fi

safe_alias change-default-editor 's update-alternatives --config editor'

### User management
safe_alias au 's adduser'
safe_alias aunop 's adduser --disabled-password'

### UFW (Uncomplicated Firewall)
if command -v ufw &>/dev/null; then
    safe_alias ufs 's ufw status verbose'      # ufw status
    safe_alias ufe 's ufw enable'              # ufw enable
    safe_alias ufd 's ufw disable'             # ufw disable
    safe_alias ufap 's ufw allow'              # ufw allow <port>
    safe_alias ufaf 's ufw allow from'         # ufw allow from <ip> (use: ufaf 1.2.3.4)
    safe_alias ufdp 's ufw deny'               # ufw deny <port>
    safe_alias ufdel 's ufw delete'            # ufw delete <rule_num>
    safe_alias ufr 's ufw reload'              # ufw reload
    safe_alias ufn 's ufw status numbered'     # ufw numbered list
fi

### Docker
if command -v docker &>/dev/null; then
    safe_alias dk 'docker'
    safe_alias dkps 'docker ps'                # running containers
    safe_alias dkpsa 'docker ps -a'            # all containers
    safe_alias dki 'docker images'             # list images
    safe_alias dkl 'docker logs'               # container logs
    safe_alias dklf 'docker logs -f'           # follow logs
    safe_alias dkx 'docker exec -it'           # exec interactive
    safe_alias dkr 'docker run -it --rm'       # run interactive, auto-remove
    safe_alias dkst 'docker stop'              # stop container
    safe_alias dkrm 'docker rm'                # remove container
    safe_alias dkrmi 'docker rmi'              # remove image
    safe_alias dkpr 'docker system prune -f'   # prune unused data
    safe_alias dkpra 'docker system prune -af' # prune all unused (including images)
fi

### Docker Compose
if command -v docker-compose &>/dev/null || docker compose version &>/dev/null 2>&1; then
    # Use 'docker compose' (v2) if available, else 'docker-compose' (v1)
    if docker compose version &>/dev/null 2>&1; then
        _DC='docker compose'
    else
        _DC='docker-compose'
    fi
    safe_alias dcp "$_DC"
    safe_alias dcup "$_DC up -d"               # up detached
    safe_alias dcdn "$_DC down"                # down
    safe_alias dcr "$_DC restart"              # restart
    safe_alias dcl "$_DC logs"                 # logs
    safe_alias dclf "$_DC logs -f"             # follow logs
    safe_alias dcps "$_DC ps"                  # ps
    safe_alias dcx "$_DC exec"                 # exec
    safe_alias dcb "$_DC build"                # build
    safe_alias dcpl "$_DC pull"                # pull
fi
